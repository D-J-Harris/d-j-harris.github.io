<!doctype html><html lang=en-US><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>Small Bytes</title><meta content=article property=og:type><meta content="Small Bytes" property=og:site_name><meta content="Small Bytes" property=og:title><meta content="Occasional posts about what I've been learning and doing" itemprop=about name=description><link href=https://d-j-harris.github.io/assets/icon.png rel=icon type=image/png><link href=https://d-j-harris.github.io/main.css rel=stylesheet><link crossorigin href=https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css integrity=sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+ rel=stylesheet><script crossorigin defer integrity=sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg src=https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js></script><script crossorigin defer integrity=sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk onload=renderMathInElement(document.body); src=https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js></script><body><header><section class=nav-container><a class=nav-title href=https://d-j-harris.github.io/> <img alt=Logo src=/assets/icon.png style=width:auto;height:3em> <h2>Small Bytes</h2> </a><nav><ul><li><a href=https://d-j-harris.github.io>Home</a><li><a href=https://d-j-harris.github.io/tags>Tags</a></ul></nav><div class=darkmode><input class=toggle id=darkmode-toggle tabindex=-1 type=checkbox><label for=darkmode-toggle id=toggle-label-light tabindex=-1><svg style="enable-background:new 0 0 35 35" viewbox="0 0 35 35" id=dayIcon version=1.1 x=0px xml:space=preserve xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink y=0px><title>Change to light mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5 S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5 C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6 C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9 c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44 l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5 c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06 L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2 C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29 c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7 C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5 c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"/></svg></label><label for=darkmode-toggle id=toggle-label-dark tabindex=-1><svg style="enable-background='new 0 0 100 100'" viewbox="0 0 100 100" id=nightIcon version=1.1 x=0px xml:space=preserve xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink y=0px><title>Change to dark mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571 C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23 c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369 c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65 c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"/></svg></label></div><script>const userPref=window.matchMedia(`(prefers-color-scheme: light)`).matches?`light`:`dark`;const currentTheme=localStorage.getItem(`theme`)??userPref;const syntaxTheme=document.querySelector(`#theme-link`);if(currentTheme){document.documentElement.setAttribute(`saved-theme`,currentTheme)};const switchTheme=a=>{let b=`saved-theme`,d=`theme`,e=`light`,c=`dark`;if(a.target.checked){document.documentElement.setAttribute(b,c);localStorage.setItem(d,c)}else{document.documentElement.setAttribute(b,e);localStorage.setItem(d,e)}};window.addEventListener(`DOMContentLoaded`,()=>{const a=document.querySelector(`#darkmode-toggle`);a.addEventListener(`change`,switchTheme,!1);if(currentTheme===`dark`){a.checked=!0}})</script></section></header><main><article class=post><section class=post-info><span>Written by</span> Daniel Harris<br><span>on </span><time datetime=2024-11-05>November 5, 2024</time></section><h1 class=post-title>Chef - a Recipe-Oriented Language</h1><section class=post-line></section><ul><li><a href=https://d-j-harris.github.io/chef-language/#design-decisions>Design Decisions</a> <ul><li><a href=https://d-j-harris.github.io/chef-language/#structure>Structure</a><li><a href=https://d-j-harris.github.io/chef-language/#naming-and-syntax>Naming and Syntax</a><li><a href=https://d-j-harris.github.io/chef-language/#scoping>Scoping</a></ul><li><a href=https://d-j-harris.github.io/chef-language/#implementation>Implementation</a> <ul><li><a href=https://d-j-harris.github.io/chef-language/#calling-functions>Calling Functions</a><li><a href=https://d-j-harris.github.io/chef-language/#garbage-collection-not>Garbage Collection (not!)</a></ul><li><a href=https://d-j-harris.github.io/chef-language/#features>Features</a> <ul><li><a href=https://d-j-harris.github.io/chef-language/#argument-lists>Argument lists</a><li><a href=https://d-j-harris.github.io/chef-language/#steps>Steps</a><li><a href=https://d-j-harris.github.io/chef-language/#vscode-extension>VSCode Extension</a></ul></ul><hr><blockquote><p>Code for this project can be found <a href=https://github.com/D-J-Harris/chef/>here</a></blockquote><br><p>Following on from my previous work on a <a href=../crafting-interpreters>Rust-based Lox interpreter</a>, I wanted to get creative and design a language that had a unique look, and would allow me to test my understanding of the content I had picked up from the <a href=https://craftinginterpreters.com/>Crafting Interpreters</a> book.<p>The outcome of this is <code>chef</code> - a recipe-oriented language! This has been a lot of fun to work on, and I want to cover some of the decision choices I made that branch from Lox, and the interesting side-effects these had in the code.<p><img alt="Fibonacci Function in Chef" title="Fibonacci Recipe in Chef" src=/assets/content/chef-language/fib_recipe.png> <em>Function to find the nth number in the Fibonacci sequence, in <code>chef</code></em><h2 id=design-decisions>Design Decisions</h2><h3 id=structure>Structure</h3><p>I wanted to design a language that looked and felt like a recipe at first sight - usability wasn’t a primary concern here. The first item to look at was code structure: usually recipes front-load the required ingredients, and move from there to step-by-step instructions. It felt natural for “ingredients” to be variables in the language, and for them to feel “global” - you wouldn’t want to be halfway through a recipe and find a new ingredient requirement!<pre style=color:#dcdcdc;background-color:#1e1e1e><code><span>Decision 1. Variable declaration should happen up-front.
</span><span>Decision 2. Programme statements should form a numbered lists of "steps".
</span></code></pre><p>There was also the question of functions, classes and closures, and modelling these concepts in a way that remains the look and feel of a recipe. In the end I decided to keep the language lean, and retain only functions in the form of their own set of “sub-steps” that should be followed. Using action words like “bake” or “whisk” for function names could help maintain this spirit.<p>I wanted the language to feel almost prose-like, with minimal nesting. So function declarations are also all declared up front. This leads itself to defining the programme in sections - you have your ingredients (variables), your actions or utensils you will need (functions) and your statements (steps). This separation also helps keep the source looking clean.<pre style=color:#dcdcdc;background-color:#1e1e1e><code><span>Decision 3. Functions declared up-front, also with their own steps.
</span><span>Decision 4. Programme should be split into sections.
</span></code></pre><h3 id=naming-and-syntax>Naming and Syntax</h3><p>When was the last time you read a recipe that asked you to whisk the EntityFactoryComponent? Or to bake <code>x</code> for 5 minutes? To address this, I moved from an <code>Ident</code> (identifier) token model, which represents <em>any</em> non-keyword string of characters, to two separate <code>VarIdent</code> and <code>FunIdent</code> tokens for variables and functions, each represented by an allow-list of words. For example, variables could only be <code>chocolate</code>, <code>banana</code>, <code>sugar</code> etc. and functions only action words like <code>whisk</code>.<p>I also decided to do away with symbols, such as parantheses in if-statements and curly braces for blocks. This led to interesting challenges, as I will discuss later, but helped to keep the prose-like style I was going for. Spoiler: the final language only uses <code>(</code> and <code>)</code> for grouping, <code>"</code> for strings and <code>,</code> for function argument lists.<pre style=color:#dcdcdc;background-color:#1e1e1e><code><span>Decision 5. Use a pre-defined list of words for variables and functions.
</span><span>Decision 6. Minimise use of symbols not used in natural language.
</span></code></pre><h3 id=scoping>Scoping</h3><p>When writing the original Lox interpreter, variables could take one of three forms: global, local or as an “upvalue” (for variables captured outside of a closure’s scope). I rid <code>chef</code> of closures, which left just two types to think about.<p>Having all variables declared up-front, and never inline, seems to lend itself well to a world where all variables are global. However, typically having only global variables can make a programme more difficult to reason about - every interaction becomes a side effect. Instead, the top-level of the programme (the outer scope) can also be interpreted as the first local scope. This final decision leads to functions being pure (no side effects), and also having fewer lookups of heap-allocated variables from some map-structure (not that I was focusing on performance).<p>In the long run, pre-defining all variables and functions in the outer scope led to the interesting property that the language does not have “call frames” in the original sense - all opcodes are contiguous, and function calls can be redirections of the instruction pointer rather than loading of function opcodes into a new call frame. Again, fewer allocations.<pre style=color:#dcdcdc;background-color:#1e1e1e><code><span>Decision 7. No global variables, and only one code block (no concept of "function code").
</span></code></pre><h2 id=implementation>Implementation</h2><p>The link to the project code can be found at the top of the article - this will not be a deep dive on every change from the Lox implementation of a compiler / bytecode interpreter to <code>chef</code>, but I wanted to highlight some of the more interesting changes<h3 id=calling-functions>Calling Functions</h3><p>The design of having all function declarations up-front means all opcodes are laid out before compiling the rest of the programme. What this means is that we can shift our view of what it means to enter a function:<p><em>before</em>:<ul><li><ol><li>Add a new frame to the call-stack</ol><li><ol start=2><li>Instruction pointer and opcodes now accessed through looking at the heap-allocated function code</ol><li><ol start=3><li>Frame captures where on the stack the function (callee) lives, with arguments coming after it</ol></ul><p><em>after</em>:<ul><li><ol><li>Jump the instruction pointer to the start of the function, capturing where you were before so you can continue where you left off once the function ends</ol><li><ol start=2><li>Profit</ol></ul><p>This is pretty cool! Functions no longer need to be heap-allocated, and can be put on the stack with minimal information required:<pre class=language-rust data-lang=rust style=color:#dcdcdc;background-color:#1e1e1e><code class=language-rust data-lang=rust><span style=color:#569cd6>pub struct </span><span>Function {
</span><span>    </span><span style=color:#569cd6>pub </span><span>name: String,    </span><span style=color:#608b4e>// only needed for debugging
</span><span>    </span><span style=color:#569cd6>pub </span><span>arity: </span><span style=color:#569cd6>u8</span><span>,       </span><span style=color:#608b4e>// only needed for error handling
</span><span>    </span><span style=color:#569cd6>pub </span><span>ip_start: </span><span style=color:#569cd6>usize</span><span>, </span><span style=color:#608b4e>// function size can be restricted to one word!
</span><span>}
</span></code></pre><h3 id=garbage-collection-not>Garbage Collection (not!)</h3><p>Unlike the core focus of my <a href=../crafting-interpreters>previous article</a>, GC did not play a role here at all! This was by design of the values that could be taken:<pre class=language-rust data-lang=rust style=color:#dcdcdc;background-color:#1e1e1e><code class=language-rust data-lang=rust><span style=color:#569cd6>pub enum </span><span>Value {
</span><span>    Nil,
</span><span>    Number(</span><span style=color:#569cd6>f64</span><span>),
</span><span>    Boolean(</span><span style=color:#569cd6>bool</span><span>),
</span><span>    String(String),
</span><span>    Function(Function),
</span><span>    NativeFunction(NativeFunction),
</span><span>}
</span></code></pre><p>When the code had closures and heap-allocated function call-frames, then it was possible for the values in the programme to become self-referential and contain cycles that could not be easily cleaned up without some form of garbage collection.<h2 id=features>Features</h2><h3 id=argument-lists>Argument lists</h3><p>Argument lists in function signatures and invocations read like proper English:<ul><li>1 argument : <code>whisk with x</code><li>2 arguments: <code>whisk with x and y</code><li>3 arguments: <code>whisk with x, y and z</code><li>4 arguments: <code>whisk with x, y, z and i</code></ul><h3 id=steps>Steps</h3><p>Yes, the code will not compile if your step count is not monotonically increasing from <code>1.</code><h3 id=vscode-extension>VSCode Extension</h3><p>I also delved into the world of extension development as part of this project, which was fun! The code can be found <a href=https://github.com/D-J-Harris/chef-colouring>here</a><p>Some neat features of this extension include the syntax declaration and colouring, as well as assistance with code indentation and step incrementing when hitting <code>Enter</code> and moving to the next step of a given function body.</article><section class=pagination><a class="left arrow" href=https://d-j-harris.github.io/crafting-interpreters/>←</a><a title="Go to top" class=top id=goToTopBtn onclick=goToTop()>Top</a><script>var goToTop=(()=>{window.scrollTo({top:0,behavior:`smooth`})})</script></section></main><footer><span class=copyright> © 2024 Daniel Harris. Powered by <a href=https://www.getzola.org><u>Zola</u></a> and <a href=https://github.com/semanticdata/mabuya>Mabuya</a>. </span><nav class=navigation-footer><ul><li><a href=https://github.com/D-J-Harris>GitHub</a><li><a href=https://www.linkedin.com/in/danj-harris/>Linkedin</a></ul></nav></footer>